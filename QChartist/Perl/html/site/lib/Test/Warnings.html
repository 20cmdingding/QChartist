<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../../displayToc.js"></script>
<script language="JavaScript" src="../../../tocParas.js"></script>
<script language="JavaScript" src="../../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#VERSION">VERSION</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a></li>
  <li><a href="#FUNCTIONS">FUNCTIONS</a>
    <ul>
      <li><a href="#allow_warnings-bool---EXPERIMENTAL---MAY-BE-REMOVED">allow_warnings([bool]) - EXPERIMENTAL - MAY BE REMOVED</a></li>
      <li><a href="#allowing_warnings---EXPERIMENTAL---MAY-BE-REMOVED">allowing_warnings - EXPERIMENTAL - MAY BE REMOVED</a></li>
      <li><a href="#had_no_warnings-optional-test-name">had_no_warnings(&lt;optional test name&gt;)</a></li>
      <li><a href="#warnings-code">warnings( { code } )</a></li>
      <li><a href="#warning-code">warning( { code } )</a></li>
    </ul>
  </li>
  <li><a href="#IMPORT-OPTIONS">IMPORT OPTIONS</a></li>
  <li><a href="#CAVEATS">CAVEATS</a></li>
  <li><a href="#TO-DO-or:-POSSIBLE-FEATURES-COMING-IN-FUTURE-RELEASES">TO DO (or: POSSIBLE FEATURES COMING IN FUTURE RELEASES)</a></li>
  <li><a href="#SUPPORT">SUPPORT</a></li>
  <li><a href="#SEE-ALSO">SEE ALSO</a></li>
  <li><a href="#AUTHOR">AUTHOR</a></li>
  <li><a href="#COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</a></li>
  <li><a href="#CONTRIBUTORS">CONTRIBUTORS</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>Test::Warnings - Test for warnings and the lack of them</p>

<h1 id="VERSION">VERSION</h1>

<p>version 0.020</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<pre><code>    <span class="keyword">use</span> <span class="variable">Test::More</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">Test::Warnings</span><span class="operator">;</span>
    
    <span class="variable">pass</span><span class="operator">(</span><span class="string">'yay!'</span><span class="operator">);</span>
    <span class="variable">done_testing</span><span class="operator">;</span>
</code></pre>

<p>emits TAP:</p>

<pre><code>    ok 1 - yay!
    ok 2 - no (unexpected) warnings (via done_testing)
    1..2</code></pre>

<p>and:</p>

<pre><code>    <span class="keyword">use</span> <span class="variable">Test::More</span> <span class="string">tests</span> <span class="operator">=&gt;</span> <span class="number">3</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">Test::Warnings</span> <span class="number">0</span><span class="operator">.</span><span class="number">005</span> <span class="string">':all'</span><span class="operator">;</span>
    
    <span class="variable">pass</span><span class="operator">(</span><span class="string">'yay!'</span><span class="operator">);</span>
    <span class="variable">like</span><span class="operator">(</span><span class="variable">warning</span> <span class="operator">{</span> <span class="keyword">warn</span> <span class="string">"oh noes!"</span> <span class="operator">},</span> <span class="string">qr/^oh noes/</span><span class="operator">,</span> <span class="string">'we warned'</span><span class="operator">);</span>
</code></pre>

<p>emits TAP:</p>

<pre><code>    ok 1 - yay!
    ok 2 - we warned
    ok 3 - no (unexpected) warnings (via END block)
    1..3</code></pre>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>If you&#39;ve ever tried to use <a>Test::NoWarnings</a> to confirm there are no warnings generated by your tests, combined with the convenience of <code>done_testing</code> to not have to declare a <a href="../../../lib/Test/More.html#I-love-it-when-a-plan-comes-together">test count</a>, you&#39;ll have discovered that these two features do not play well together, as the test count will be calculated <i>before</i> the warnings test is run, resulting in a TAP error. (See <code>examples/test_nowarnings.pl</code> in this distribution for a demonstration.)</p>

<p>This module is intended to be used as a drop-in replacement for <a>Test::NoWarnings</a>: it also adds an extra test, but runs this test <i>before</i> <code>done_testing</code> calculates the test count, rather than after. It does this by hooking into <code>done_testing</code> as well as via an <code>END</code> block. You can declare a plan, or not, and things will still Just Work.</p>

<p>It is actually equivalent to:</p>

<pre><code>    <span class="keyword">use</span> <span class="variable">Test::NoWarnings</span> <span class="number">1.04</span> <span class="string">':early'</span><span class="operator">;</span>
</code></pre>

<p>as warnings are still printed normally as they occur. You are safe, and enthusiastically encouraged, to perform a global search-replace of the above with <code><span class="keyword">use</span> <span class="variable">Test::Warnings</span><span class="operator">;</span>
</code> whether or not your tests have a plan.</p>

<p>It can also be used as a replacement for <a>Test::Warn</a>, if you wish to test the content of expected warnings; read on to find out how.</p>

<h1 id="FUNCTIONS">FUNCTIONS</h1>

<p>The following functions are available for import (not included by default; you can also get all of them by importing the tag <code>:all</code>):</p>

<h2 id="allow_warnings-bool---EXPERIMENTAL---MAY-BE-REMOVED"><code>allow_warnings([bool])</code> - EXPERIMENTAL - MAY BE REMOVED</h2>

<p>When passed a true value, or no value at all, subsequent warnings will not result in a test failure; when passed a false value, subsequent warnings will result in a test failure. Initial value is <code>false</code>.</p>

<p>When warnings are allowed, any warnings will instead be emitted via <a href="../../../lib/Test/Builder.html#Output">Test::Builder::note</a>.</p>

<h2 id="allowing_warnings---EXPERIMENTAL---MAY-BE-REMOVED"><code>allowing_warnings</code> - EXPERIMENTAL - MAY BE REMOVED</h2>

<p>Returns whether we are currently allowing warnings (set by <code>allow_warnings</code> as described above).</p>

<h2 id="had_no_warnings-optional-test-name"><code>had_no_warnings(&lt;optional test name&gt;)</code></h2>

<p>Tests whether there have been any warnings so far, not preceded by an <code>allowing_warnings</code> call. It is run automatically at the end of all tests, but can also be called manually at any time, as often as desired.</p>

<h2 id="warnings-code"><code><span class="variable">warnings</span><span class="operator">(</span> <span class="operator">{</span> <span class="string">code</span> <span class="operator">}</span> <span class="operator">)</span>
</code></h2>

<p>Given a code block, runs the block and returns a list of all the (not previously allowed via <code>allow_warnings</code>) warnings issued within. This lets you test for the presence of warnings that you not only would <i>allow</i>, but <i>must</i> be issued. Testing functions are not provided; given the strings returned, you can test these yourself using your favourite testing functions, such as <a href="../../../lib/Test/More.html#is">Test::More::is</a> or <a>Test::Deep::cmp_deeply</a>.</p>

<p>You can use this construct as a replacement for <a>Test::Warn::warnings_are</a>:</p>

<pre><code>    <span class="variable">is_deeply</span><span class="operator">(</span>
        <span class="operator">[</span> <span class="variable">warnings</span> <span class="operator">{</span> <span class="operator">...</span> <span class="operator">}</span> <span class="operator">]</span><span class="operator">,</span>
        <span class="operator">[</span>
            <span class="string">'warning message 1'</span><span class="operator">,</span>
            <span class="string">'warning message 2'</span><span class="operator">,</span>
        <span class="operator">]</span><span class="operator">,</span>
        <span class="string">'got expected warnings'</span><span class="operator">,</span>
    <span class="operator">);</span>
</code></pre>

<p>or, to replace <a>Test::Warn::warnings_like</a>:</p>

<pre><code>    <span class="variable">cmp_deeply</span><span class="operator">(</span>
        <span class="operator">[</span> <span class="variable">warnings</span> <span class="operator">{</span> <span class="operator">...</span> <span class="operator">}</span> <span class="operator">]</span><span class="operator">,</span>
        <span class="variable">bag</span><span class="operator">(</span>    <span class="comment"># ordering of messages doesn't matter</span>
            <span class="variable">re</span><span class="operator">(</span><span class="string">qr/warning message 1/</span><span class="operator">),</span>
            <span class="variable">re</span><span class="operator">(</span><span class="string">qr/warning message 2/</span><span class="operator">),</span>
        <span class="operator">),</span>
        <span class="string">'got expected warnings (in any order)'</span><span class="operator">,</span>
    <span class="operator">);</span>
</code></pre>

<p>Warnings generated by this code block are <i>NOT</i> propagated further. However, since they are returned from this function with their filename and line numbers intact, you can re-issue them yourself immediately after calling <code>warnings(...)</code>, if desired.</p>

<h2 id="warning-code"><code><span class="variable">warning</span><span class="operator">(</span> <span class="operator">{</span> <span class="string">code</span> <span class="operator">}</span> <span class="operator">)</span>
</code></h2>

<p>Same as <code><span class="variable">warnings</span><span class="operator">(</span> <span class="operator">{</span> <span class="string">code</span> <span class="operator">}</span> <span class="operator">)</span>
</code>, except a scalar is always returned - the single warning produced, if there was one, or an arrayref otherwise -- which can be more convenient to use than <code>warnings()</code> if you are expecting exactly one warning.</p>

<p>However, you are advised to capture the result from <code>warning()</code> into a temp variable so you can dump its value if it doesn&#39;t contain what you expect. e.g. with this test:</p>

<pre><code>    <span class="variable">like</span><span class="operator">(</span>
        <span class="variable">warning</span> <span class="operator">{</span> <span class="variable">foo</span><span class="operator">()</span> <span class="operator">},</span>
        <span class="string">qr/^this is a warning/</span><span class="operator">,</span>
        <span class="string">'got a warning from foo()'</span><span class="operator">,</span>
    <span class="operator">);</span>
</code></pre>

<p>if you get two warnings (or none) back instead of one, you&#39;ll get an arrayref, which will result in an unhelpful test failure message like:</p>

<pre><code>    <span class="comment">#   Failed test 'got a warning from foo()'</span>
    <span class="comment">#   at t/mytest.t line 10.</span>
    <span class="comment">#                   'ARRAY(0xdeadbeef)'</span>
    <span class="comment">#     doesn't match '(?^:^this is a warning)'</span>
</code></pre>

<p>So instead, change your test to:</p>

<pre><code>    <span class="keyword">my</span> <span class="variable">$warning</span> <span class="operator">=</span> <span class="variable">warning</span> <span class="operator">{</span> <span class="variable">foo</span><span class="operator">()</span> <span class="operator">};</span>
    <span class="variable">like</span><span class="operator">(</span>
        <span class="variable">$warning</span><span class="operator">,</span>
        <span class="string">qr/^this is a warning/</span><span class="operator">,</span>
        <span class="string">'got a warning from foo()'</span><span class="operator">,</span>
    <span class="operator">)</span> <span class="keyword">or</span> <span class="variable">diag</span> <span class="string">'got warning(s): '</span><span class="operator">,</span> <span class="variable">explain</span><span class="operator">(</span><span class="variable">$warning</span><span class="operator">);</span>
</code></pre>

<h1 id="IMPORT-OPTIONS">IMPORT OPTIONS</h1>

<ul>

<li><p><code>:all</code> - Imports all functions listed above</p>

</li>
<li><p><code>:no_end_test</code> - Disables the addition of a <code>had_no_warnings</code> test via <code>END</code> or <code>done_testing</code></p>

</li>
</ul>

<h1 id="CAVEATS">CAVEATS</h1>

<p>Sometimes new warnings can appear in Perl that should <b>not</b> block installation -- for example, smartmatch was recently deprecated in perl 5.17.11, so now any distribution that uses smartmatch and also tests for warnings cannot be installed under 5.18.0. You might want to consider only making warnings fail tests in an author environment -- you can do this with the <a href="../../../lib/if.html">if</a> pragma:</p>

<pre><code>    <span class="keyword">use</span> <span class="keyword">if</span> <span class="variable">$ENV</span><span class="operator">{</span><span class="string">AUTHOR_TESTING</span><span class="operator">}</span> <span class="operator">||</span> <span class="variable">$ENV</span><span class="operator">{</span><span class="string">RELEASE_TESTING</span><span class="operator">}</span><span class="operator">,</span> <span class="string">'Test::Warnings'</span><span class="operator">;</span>
</code></pre>

<p>In future versions of this module, when interfaces are added to test the content of warnings, there will likely be additional sugar available to indicate that warnings should be checked only in author tests (or TODO when not in author testing), but will still provide exported subs. Comments are enthusiastically solicited - drop me an email, write up an RT ticket, or come by <code><span class="comment">#perl-qa</span>
</code> on irc!</p>

<p><b>Achtung!</b> This is not a great idea:</p>

<pre><code>    <span class="keyword">sub</span><span class="variable"> warning_like</span><span class="operator">(</span>&amp;$;$<span class="operator">)</span> <span class="operator">{</span>
        <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$code</span><span class="operator">,</span> <span class="variable">$pattern</span><span class="operator">,</span> <span class="variable">$name</span><span class="operator">)</span> <span class="operator">=</span> <span class="variable">@_</span><span class="operator">;</span>
        <span class="variable">like</span><span class="operator">(</span> <span class="operator">&amp;</span><span class="variable">warning</span><span class="operator">(</span><span class="variable">$code</span><span class="operator">),</span> <span class="variable">$pattern</span><span class="operator">,</span> <span class="variable">$name</span> <span class="operator">);</span>
    <span class="operator">}</span>
    
    <span class="variable">warning_like</span><span class="operator">(</span> <span class="operator">{</span> <span class="operator">...</span> <span class="operator">}</span><span class="operator">,</span> <span class="string">qr/foo/</span><span class="operator">,</span> <span class="string">'foo appears in the warning'</span> <span class="operator">);</span>
</code></pre>

<p>If the code in the <code><span class="operator">{</span> <span class="operator">...</span> <span class="operator">}</span>
</code> is going to warn with a stack trace with the arguments to each subroutine in its call stack (for example via <code>Carp::cluck</code>), the test name, &quot;foo appears in the warning&quot; will itself be matched by the regex (see <i>examples/warning_like.t</i>). Instead, write this:</p>

<pre><code>  <span class="variable">like</span><span class="operator">(</span> <span class="variable">warning</span> <span class="operator">{</span> <span class="operator">...</span> <span class="operator">},</span> <span class="string">qr/foo/</span><span class="operator">,</span> <span class="string">'foo appears in the warning'</span> <span class="operator">);</span>
</code></pre>

<h1 id="TO-DO-or:-POSSIBLE-FEATURES-COMING-IN-FUTURE-RELEASES">TO DO (or: POSSIBLE FEATURES COMING IN FUTURE RELEASES)</h1>

<ul>

<li><p><code>allow_warnings(qr/.../)</code> - allow some warnings and not others</p>

</li>
<li><p>more sophisticated handling in subtests - if we save some state on the <a href="../../../lib/Test/Builder.html">Test::Builder</a> object itself, we can allow warnings in a subtest and then the state will revert when the subtest ends, as well as check for warnings at the end of every subtest via <code>done_testing</code>.</p>

</li>
<li><p>sugar for making failures TODO when testing outside an author environment</p>

</li>
</ul>

<h1 id="SUPPORT">SUPPORT</h1>

<p>Bugs may be submitted through <a href="https://rt.cpan.org/Public/Dist/Display.html?Name=Test-Warnings">https://rt.cpan.org/Public/Dist/Display.html?Name=Test-Warnings</a>. I am also usually active on irc, as &#39;ether&#39; at <code>irc.perl.org</code>.</p>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<ul>

<li><p><a>Test::NoWarnings</a></p>

</li>
<li><p><a>Test::FailWarnings</a></p>

</li>
<li><p><a href="http://blogs.perl.org/users/ether/2013/03/yanwt-yet-another-no-warnings-tester.html">blogs.perl.org: YANWT (Yet Another No-Warnings Tester)</a></p>

</li>
<li><p><a>strictures</a> - which makes all warnings fatal in tests, hence lessening</p>

<p>the need for special warning testing</p>

</li>
<li><p><a>Test::Warn</a></p>

</li>
<li><p><a href="../../../site/lib/Test/Fatal.html">Test::Fatal</a></p>

</li>
</ul>

<h1 id="AUTHOR">AUTHOR</h1>

<p>Karen Etheridge &lt;ether@cpan.org&gt;</p>

<h1 id="COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</h1>

<p>This software is copyright (c) 2013 by Karen Etheridge.</p>

<p>This is free software; you can redistribute it and/or modify it under the same terms as the Perl 5 programming language system itself.</p>

<h1 id="CONTRIBUTORS">CONTRIBUTORS</h1>

<ul>

<li><p>A. Sinan Unur &lt;nanis@cpan.org&gt;</p>

</li>
<li><p>Graham Knop &lt;haarg@haarg.org&gt;</p>

</li>
<li><p>Leon Timmermans &lt;fawaka@gmail.com&gt;</p>

</li>
</ul>


</body>

</html>


