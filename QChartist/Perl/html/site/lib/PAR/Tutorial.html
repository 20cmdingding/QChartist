<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../../displayToc.js"></script>
<script language="JavaScript" src="../../../tocParas.js"></script>
<script language="JavaScript" src="../../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a>
    <ul>
      <li><a href="#On-Deploying-Perl-Applications">On Deploying Perl Applications</a></li>
      <li><a href="#PAR-the-Perl-Archive-Toolkit">PAR, the Perl Archive Toolkit</a></li>
      <li><a href="#Simple-Packaging">Simple Packaging</a></li>
      <li><a href="#PAR-Loaders">PAR Loaders</a></li>
      <li><a href="#Dependency-Scanning">Dependency Scanning</a></li>
      <li><a href="#Perl-Packager:-pp">Perl Packager: pp</a></li>
      <li><a href="#How-it-works">How it works</a></li>
      <li><a href="#Aggregating-multiple-programs">Aggregating multiple programs</a></li>
      <li><a href="#Cross-platform-Packages">Cross-platform Packages</a></li>
      <li><a href="#The-Anatomy-of-a-PAR-file">The Anatomy of a PAR file</a></li>
      <li><a href="#Special-files">Special files</a></li>
      <li><a href="#Advantages-over-perlcc-PerlApp-and-Perl2exe">Advantages over perlcc, PerlApp and Perl2exe</a></li>
      <li><a href="#MANIFEST:-Best-viewed-with-Mozilla">MANIFEST: Best viewed with Mozilla</a></li>
      <li><a href="#META.yml:-Metadata-galore">META.yml: Metadata galore</a></li>
      <li><a href="#SIGNATURE:-Signing-and-verifying-packages">SIGNATURE: Signing and verifying packages</a></li>
      <li><a href="#Perl-Servlets-with-Apache::PAR">Perl Servlets with Apache::PAR</a></li>
      <li><a href="#Hon-Dah-A-par-che">Hon Dah, A-par-che!</a></li>
      <li><a href="#On-demand-library-fetching">On-demand library fetching</a></li>
      <li><a href="#Code-Obfuscation">Code Obfuscation</a></li>
      <li><a href="#Accessing-packed-files">Accessing packed files</a></li>
      <li><a href="#Packing-GUI-applications">Packing GUI applications</a></li>
      <li><a href="#Precompiled-CPAN-distributions">Precompiled CPAN distributions</a></li>
      <li><a href="#Platform-specific-Tips">Platform-specific Tips</a></li>
      <li><a href="#Thank-you">Thank you!</a></li>
      <li><a href="#Bonus-Slides:-PAR-Internals">Bonus Slides: PAR Internals</a></li>
      <li><a href="#Overview-of-PAR.pms-Implementation">Overview of PAR.pm&#39;s Implementation</a></li>
      <li><a href="#Code-References-in-INC">Code References in @INC</a></li>
      <li><a href="#Source-Filtering-without-Filter::-Modules">Source Filtering without Filter::* Modules</a></li>
      <li><a href="#Source-Filtering-without-Filter::-Modules-cont">Source Filtering without Filter::* Modules (cont.)</a></li>
      <li><a href="#Overriding-DynaLoader::bootstrap">Overriding DynaLoader::bootstrap</a></li>
      <li><a href="#Anatomy-of-a-Self-Contained-PAR-executable">Anatomy of a Self-Contained PAR executable</a></li>
      <li><a href="#Self-Bootstrapping-Tricks">Self-Bootstrapping Tricks</a></li>
      <li><a href="#Thank-you-again">Thank you (again)!</a></li>
    </ul>
  </li>
  <li><a href="#SEE-ALSO">SEE ALSO</a></li>
  <li><a href="#AUTHORS">AUTHORS</a></li>
  <li><a href="#COPYRIGHT">COPYRIGHT</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>PAR::Tutorial - Cross-Platform Packaging and Deployment with PAR</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<p>This is a tutorial on PAR, first appeared at the 7th Perl Conference. The HTML version of this tutorial is available online as <a href="http://search.cpan.org/perldoc?PAR::Tutorial">http://search.cpan.org/perldoc?PAR::Tutorial</a></p>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<h2 id="On-Deploying-Perl-Applications">On Deploying Perl Applications</h2>

<pre><code> % sshnuke.pl 10.2.2.2 -rootpw=&quot;Z1ON0101&quot;
 Perl v5.6.1 required--this is only v5.6.0, stopped at sshnuke.pl line 1.
 BEGIN failed--compilation aborted at sshnuke.pl line 1.</code></pre>

<ul>

<li><p>Q: &quot;Help! I can&#39;t run your program!&quot;</p>

</li>
<li><p>A1: Install Perl &amp; <code>perl -MCPAN -e&#39;install(...)&#39;</code></p>

<ul>

<li><p>How do we know which modules are needed?</p>

</li>
<li><p>New versions of CPAN modules may break <code>sshnuke.pl</code></p>

</li>
</ul>

</li>
<li><p>A2: Install Perl &amp; <code>tar zxf my_perllib.tgz</code></p>

<ul>

<li><p>Possibly overwriting existing modules; not cross-platform at all</p>

</li>
</ul>

</li>
<li><p>A3: Use the executable generated by <code>perlcc sshnuke.pl</code></p>

<ul>

<li><p>Impossible to debug; <code>perlcc</code> usually does not work anyway</p>

</li>
</ul>

</li>
</ul>

<h2 id="PAR-the-Perl-Archive-Toolkit">PAR, the Perl Archive Toolkit</h2>

<ul>

<li><p>Do what JAR (Java Archive) does for Perl</p>

<ul>

<li><p>Aggregates modules, scripts and other files into a Zip file</p>

</li>
<li><p>Easy to generate, update and extract</p>

</li>
<li><p>Version consistency: solves forward-compatibility problems</p>

</li>
<li><p>Developed by community: <code>par@perl.org</code></p>

</li>
</ul>

</li>
<li><p>PAR files can be packed into self-contained scripts</p>

<ul>

<li><p>Automatically scans perl script for dependencies</p>

</li>
<li><p>Bundles all necessary 3rd-party modules with it</p>

</li>
<li><p>Requires only core Perl to run on the target machine</p>

</li>
<li><p>PAR also comes with <code>pp</code>, the Perl Packager:</p>

<pre><code> % pp -o sshnuke.exe sshnuke.pl # stand-alone executable!</code></pre>

</li>
</ul>

</li>
</ul>

<h2 id="Simple-Packaging">Simple Packaging</h2>

<ul>

<li><p>PAR files are just Zip files with modules in it</p>

</li>
<li><p>Any Zip tools can generate them:</p>

<pre><code> % zip foo.par Hello.pm World.pm        # pack two modules
 % zip -r bar.par lib/          # grab all modules in lib/</code></pre>

</li>
<li><p>To load modules from PAR files:</p>

<pre><code> <span class="keyword">use</span> <span class="variable">PAR</span><span class="operator">;</span>
 <span class="keyword">use</span> <span class="variable">lib</span> <span class="string">"foo.par"</span><span class="operator">;</span>             <span class="comment"># the .par part is optional</span>
 <span class="keyword">use</span> <span class="variable">Hello</span><span class="operator">;</span>
</code></pre>

</li>
<li><p>This also works:</p>

<pre><code> <span class="keyword">use</span> <span class="variable">PAR</span> <span class="string">"/home/mylibs/*.par"</span><span class="operator">;</span>  <span class="comment"># put all of them into @INC</span>
 <span class="keyword">use</span> <span class="variable">Hello</span><span class="operator">;</span>
</code></pre>

</li>
</ul>

<h2 id="PAR-Loaders">PAR Loaders</h2>

<ul>

<li><p>Use <code>par.pl</code> to run files inside a PAR archive:</p>

<pre><code> % par.pl foo.par               # looks for &#39;main.pl&#39; by default
 % par.pl foo.par test.pl       # runs script/test.pl in foo.par</code></pre>

</li>
<li><p>Same thing, with the stand-alone <code>parl</code> or <code>parl.exe</code>:</p>

<pre><code> % parl foo.par                 # no perl or PAR.pm needed!
 % parl foo.par test.pl         # ditto</code></pre>

</li>
<li><p>The PAR loader can prepend itself to a PAR file:</p>

<ul>

<li><p><code>-b</code> bundles non-core modules needed by <code>PAR.pm</code>:</p>

<pre><code> % par.pl -b -O./foo.pl foo.par # self-contained script</code></pre>

</li>
<li><p><code>-B</code> bundles core modules in addition to <code>-b</code>:</p>

<pre><code> % parl -B -O./foo.exe foo.par  # self-contained binary</code></pre>

</li>
</ul>

</li>
</ul>

<h2 id="Dependency-Scanning">Dependency Scanning</h2>

<ul>

<li><p>Recursively scan dependencies with <code>scandeps.pl</code>:</p>

<pre><code> % scandeps.pl sshnuke.pl
 # Legend: [C]ore [X]ternal [S]ubmodule [?]NotOnCPAN
 &#39;Crypt::SSLeay&#39;       =&gt; &#39;0&#39;, #  X   #
 &#39;Net::HTTP&#39;           =&gt; &#39;0&#39;, #      #
 &#39;Crypt::SSLeay::X509&#39; =&gt; &#39;0&#39;, # S    # Crypt::SSLeay
 &#39;Net::HTTP::Methods&#39;  =&gt; &#39;0&#39;, # S    # Net::HTTP
 &#39;Compress::Zlib&#39;      =&gt; &#39;0&#39;, #  X   # Net::HTTP::Methods</code></pre>

</li>
<li><p>Scan an one-liner, list all involved files:</p>

<pre><code> <span class="operator">% </span><span class="variable">scandeps</span><span class="operator">.</span><span class="variable">pl</span> <span class="operator">-</span><span class="variable">V</span> <span class="keyword">-e</span> <span class="string">"use Dynaloader;"</span>
 <span class="operator">...</span>
 <span class="comment"># auto/DynaLoader/dl_findfile.al [autoload]</span>
 <span class="comment"># auto/DynaLoader/extralibs.ld [autoload]</span>
 <span class="comment"># auto/File/Glob/Glob.bs [data]</span>
 <span class="comment"># auto/File/Glob/Glob.so [shared]</span>
 <span class="operator">...</span>
</code></pre>

</li>
</ul>

<h2 id="Perl-Packager:-pp">Perl Packager: <code>pp</code></h2>

<ul>

<li><p>Combines scanning, zipping and loader-embedding:</p>

<pre><code> % pp -o out.exe src.pl         # self-contained .exe
 % out.exe                      # runs anywhere on the same OS</code></pre>

</li>
<li><p>Bundle additional modules:</p>

<pre><code> % pp -o out.exe -M CGI src.pl  # pack CGI + its dependencies, too</code></pre>

</li>
<li><p>Pack one-liners:</p>

<pre><code> % pp -o out.exe -e &#39;print &quot;Hi!&quot;&#39;   # turns one-liner into executable
    </code></pre>

</li>
<li><p>Generate PAR files instead of executables:</p>

<pre><code> % pp -p src.pl                 # makes &#39;source.par&#39;
 % pp -B -p src.pl              # include core modules</code></pre>

</li>
</ul>

<h2 id="How-it-works">How it works</h2>

<ul>

<li><p>Command-line options are almost identical to <code>perlcc</code>&#39;s</p>

<ul>

<li><p>Also supports <code>gcc</code>-style long options:</p>

<pre><code> % pp --gui --verbose --output=out.exe src.pl</code></pre>

</li>
</ul>

</li>
<li><p>Small initial overhead; no runtime overhead</p>

</li>
<li><p>Dependencies are POD-stripped before packing</p>

</li>
<li><p>Loads modules directly into memory on demand</p>

</li>
<li><p>Shared libraries (DLLs) are extracted with File::Temp</p>

</li>
<li><p>Works on Perl 5.6.0 or above</p>

</li>
<li><p>Tested on Win32 (VC++ and MinGW), FreeBSD, NetBSD, Linux, MacOSX, Cygwin, AIX, Solaris, HP-UX, Tru64...</p>

</li>
</ul>

<h2 id="Aggregating-multiple-programs">Aggregating multiple programs</h2>

<ul>

<li><p>A common question:</p>

<pre><code> &gt; I have used pp to make several standalone applications which work
 &gt; great, the only problem is that for each executable that I make, I am
 &gt; assuming the parl.exe is somehow bundled into the resulting exe.</code></pre>

</li>
<li><p>The obvious workaround:</p>

<pre><code> You can ship parl.exe by itself, along with .par files built
 by &quot;pp -p&quot;, and run those PAR files by associating them to parl.exe.</code></pre>

</li>
<li><p>On platforms that have <code>ln</code>, there is a better solution:</p>

<pre><code> % pp --output=a.out a.pl b.pl  # two scripts in one!
 % ln a.out b.out               # symlink also works
 % ./a.out                      # runs a.pl
 % ./b.out                      # runs b.pl</code></pre>

</li>
</ul>

<h2 id="Cross-platform-Packages">Cross-platform Packages</h2>

<ul>

<li><p>Of course, there is no cross-platform binary format</p>

</li>
<li><p>Pure-perl PAR packages are cross-platform by default</p>

<ul>

<li><p>However, XS modules are specific to Perl version and platform</p>

</li>
<li><p>Multiple versions of a XS module can co-exist in a PAR file</p>

</li>
</ul>

</li>
<li><p>Suppose we need <code>out.par</code> on both Win32 and Finix:</p>

<pre><code> C:\&gt; pp --multiarch --output=out.par src.pl
 ...copy src.pl and out.par to a Finix machine...
 % pp --multiarch --output=out.par src.pl</code></pre>

</li>
<li><p>Now it works on both platforms:</p>

<pre><code> % parl out.par                 # runs src.pl
 % perl -MPAR=out.par -e &#39;...&#39;  # uses modules inside out.par</code></pre>

</li>
</ul>

<h2 id="The-Anatomy-of-a-PAR-file">The Anatomy of a PAR file</h2>

<ul>

<li><p>Modules can reside in several directories:</p>

<pre><code> <span class="regex">/                      # casual packaging only
 /lib</span><span class="operator">/</span>                  <span class="comment"># standard location</span>
 <span class="regex">/arch/</span>                 <span class="comment"># for creating from blib/ </span>
 <span class="operator">/</span><span class="variable">i386</span><span class="operator">-</span><span class="variable">freebsd</span><span class="operator">/</span>         <span class="comment"># i.e. $Config{archname}</span>
 <span class="regex">/5.8.0/</span>                <span class="comment"># i.e. Perl version number</span>
 <span class="operator">/</span><span class="number">5.8</span><span class="operator">.</span><span class="number">0</span><span class="operator">/</span><span class="variable">i386</span><span class="operator">-</span><span class="variable">freebsd</span><span class="operator">/</span>   <span class="comment"># combination of the two above</span>
</code></pre>

</li>
<li><p>Scripts are stored in one of the two locations:</p>

<pre><code> /                      # casual packaging only
 /script/               # standard location</code></pre>

</li>
<li><p>Shared libraries may be architecture- or perl-version-specific:</p>

<pre><code> /shlib/(5.8.0/)?(i386-freebsd/)?</code></pre>

</li>
<li><p>PAR files may recursively contain other PAR files:</p>

<pre><code> /par/(5.8.0/)?(i386-freebsd/)?</code></pre>

</li>
</ul>

<h2 id="Special-files">Special files</h2>

<ul>

<li><p>MANIFEST</p>

<ul>

<li><p>Index of all files inside PAR</p>

</li>
<li><p>Can be parsed with <code>ExtUtils::Manifest</code></p>

</li>
</ul>

</li>
<li><p>META.yml</p>

<ul>

<li><p>Dependency, license, runtime options</p>

</li>
<li><p>Can be parsed with <code>YAML</code></p>

</li>
</ul>

</li>
<li><p>SIGNATURE</p>

<ul>

<li><p>OpenPGP-signed digital signature</p>

</li>
<li><p>Can be parsed and verified with <code>Module::Signature</code></p>

</li>
</ul>

</li>
</ul>

<h2 id="Advantages-over-perlcc-PerlApp-and-Perl2exe">Advantages over perlcc, PerlApp and Perl2exe</h2>

<ul>

<li><p>This is not meant to be a flame</p>

<ul>

<li><p>All three maintainers have contributed to PAR directly; I&#39;m grateful</p>

</li>
</ul>

</li>
<li><p>perlcc</p>

<ul>

<li><p>&quot;The code generated in this way is not guaranteed to work... Use for production purposes is strongly discouraged.&quot; (from perldoc perlcc)</p>

</li>
<li><p><i>Guaranteed to not work</i> is more like it</p>

</li>
</ul>

</li>
<li><p>PerlApp / Perl2exe</p>

<ul>

<li><p>Expensive: Need to pay for each upgrade</p>

</li>
<li><p>Non-portable: Only available for limited platforms</p>

</li>
<li><p>Proprietary: Cannot extend its features or fix bugs</p>

</li>
<li><p>Obfuscated: Vendor and black-hats can see your code, but you can&#39;t</p>

</li>
<li><p>Inflexible: Does not work with existing Perl installations</p>

</li>
</ul>

</li>
</ul>

<h2 id="MANIFEST:-Best-viewed-with-Mozilla">MANIFEST: Best viewed with Mozilla</h2>

<ul>

<li><p>The URL of <code>MANIFEST</code> inside <code>/home/autrijus/foo.par</code>:</p>

<pre><code> jar:file:///home/autrijus/foo.par!/MANIFEST</code></pre>

</li>
<li><p>Open it in a Gecko browser (e.g. Netscape 6+) with Javascript enabled:</p>

</li>
<li><p>No needed to unzip anything; just click on files to view them</p>

</li>
</ul>

<h2 id="META.yml:-Metadata-galore">META.yml: Metadata galore</h2>

<ul>

<li><p>Static, machine-readable distribution metadata</p>

<ul>

<li><p>Supported by <code>Module::Build</code>, <code>ExtUtils::MakeMaker</code>, <code>Module::Install</code></p>

</li>
</ul>

</li>
<li><p>A typical <code>pp</code>-generated <code>META.yml</code> looks like this:</p>

<pre><code> <span class="variable">build_requires</span><span class="operator">:</span> <span class="operator">{}</span>
 <span class="variable">conflicts</span><span class="operator">:</span> <span class="operator">{}</span>
 <span class="variable">dist_name</span><span class="operator">:</span> <span class="variable">out</span><span class="operator">.</span><span class="variable">par</span>
 <span class="variable">distribution_type</span><span class="operator">:</span> <span class="variable">par</span>
 <span class="variable">dynamic_config</span><span class="operator">:</span> <span class="number">0</span>
 <span class="variable">generated_by</span><span class="operator">:</span> <span class="string">'Perl Packager version 0.03'</span>
 <span class="variable">license</span><span class="operator">:</span> <span class="variable">unknown</span>
 <span class="variable">par</span><span class="operator">:</span>
   <span class="variable">clean</span><span class="operator">:</span> <span class="number">0</span>
   <span class="variable">signature</span><span class="operator">:</span> <span class="string">''</span>
   <span class="variable">verbatim</span><span class="operator">:</span> <span class="number">0</span>
   <span class="variable">version</span><span class="operator">:</span> <span class="number">0</span><span class="operator">.</span><span class="number">68</span>
</code></pre>

</li>
<li><p>The <code>par:</code> settings controls its runtime behavior</p>

</li>
</ul>

<h2 id="SIGNATURE:-Signing-and-verifying-packages">SIGNATURE: Signing and verifying packages</h2>

<ul>

<li><p>OpenPGP clear-signed manifest with SHA1 digests</p>

<ul>

<li><p>Supported by <code>Module::Signature</code>, <code>CPANPLUS</code> and <code>Module::Build</code></p>

</li>
</ul>

</li>
<li><p>A typical <code>SIGNATURE</code> looks like this:</p>

<pre><code> -----BEGIN PGP SIGNED MESSAGE-----
 Hash: SHA1

 SHA1 8a014cd6d0f6775552a01d1e6354a69eb6826046 AUTHORS
 ...
 -----BEGIN PGP SIGNATURE-----
 ...
 -----END PGP SIGNATURE-----</code></pre>

</li>
<li><p>Use <code>pp</code> and <code>cpansign</code> to work with signatures:</p>

<pre><code> % pp -s -o foo.par bar.pl      # make and sign foo.par from bar.pl
 % cpansign -s foo.par  # sign this PAR file
 % cpansign -v foo.par  # verify this PAR file</code></pre>

</li>
</ul>

<h2 id="Perl-Servlets-with-Apache::PAR">Perl Servlets with Apache::PAR</h2>

<ul>

<li><p>Framework for self-contained Web applications</p>

<ul>

<li><p>Similar to Java&#39;s &quot;Web Application Archive&quot; (WAR) files</p>

</li>
<li><p>Works with mod_perl 1.x or 2.x</p>

</li>
</ul>

</li>
<li><p>A complete web application inside a <code>.par</code> file</p>

<ul>

<li><p>Apache configuration, static files, Perl modules...</p>

</li>
<li><p>Supports Static, Registry and PerlRun handlers</p>

</li>
<li><p>Can also load all PARs under a directory</p>

</li>
</ul>

</li>
<li><p>One additional special file: <code>web.conf</code></p>

<pre><code> Alias /myapp/cgi-perl/ ##PARFILE##/
 &lt;Location /myapp/cgi-perl&gt;
     Options +ExecCGI
     SetHandler perl-script
     PerlHandler Apache::PAR::Registry
 &lt;/Location&gt;</code></pre>

</li>
</ul>

<h2 id="Hon-Dah-A-par-che">Hon Dah, A-par-che!</h2>

<ul>

<li><p>First, make a <code>hondah.par</code> from an one-liner:</p>

<pre><code> # use the &quot;web.conf&quot; from the previous slide
 % pp -p -o hondah.par -e &#39;print &quot;Hon Dah!\n&quot;&#39; \
      --add web.conf
 % chmod a+x hondah.par</code></pre>

</li>
<li><p>Add this to <code>httpd.conf</code>, then restart apache:</p>

<pre><code> &lt;IfDefine MODPERL2&gt;
 PerlModule Apache2
 &lt;/IfDefine&gt;
 PerlAddVar PARInclude /home/autrijus/hondah.par
 PerlModule Apache::PAR</code></pre>

</li>
<li><p>Test it out:</p>

<pre><code> % GET http://localhost/myapp/cgi-perl/main.pl
 Hon Dah!</code></pre>

</li>
<li><p>Instant one-liner web application that works!</p>

</li>
</ul>

<h2 id="On-demand-library-fetching">On-demand library fetching</h2>

<ul>

<li><p>With LWP installed, your can use remote PAR files:</p>

<pre><code> <span class="keyword">use</span> <span class="variable">PAR</span><span class="operator">;</span>
 <span class="keyword">use</span> <span class="variable">lib</span> <span class="string">'http://aut.dyndns.org/par/DBI-latest.par'</span><span class="operator">;</span>
 <span class="keyword">use</span> <span class="variable">DBI</span><span class="operator">;</span>    <span class="comment"># always up to date!</span>
</code></pre>

</li>
<li><p>Modules are now cached under <code><span class="variable">$ENV</span><span class="operator">{</span><span class="string">PAR_GLOBAL_TEMP</span><span class="operator">}</span>
</code></p>

</li>
<li><p>Auto-updates with <code>LWP::Simple::mirror</code></p>

<ul>

<li><p>Download only if modified</p>

</li>
<li><p>Safe for offline use after the first time</p>

</li>
<li><p>May use <code>SIGNATURE</code> to prevent DNS-spoofing</p>

</li>
</ul>

</li>
<li><p>Makes large-scale deployment a breeze</p>

<ul>

<li><p>Upgrades from a central location</p>

</li>
<li><p>No installers needed</p>

</li>
</ul>

</li>
</ul>

<h2 id="Code-Obfuscation">Code Obfuscation</h2>

<ul>

<li><p>Also known as <i>source-hiding</i> techniques</p>

<ul>

<li><p>It is <i>not</i> encryption</p>

</li>
<li><p>Offered by PerlApp, Perl2Exe, Stunnix...</p>

</li>
</ul>

</li>
<li><p>Usually easy to defeat</p>

<ul>

<li><p>Take optree dump from memory, feed to <code>B::Deparse</code></p>

</li>
<li><p>If you just want to stop a casual <code>grep</code>, &quot;deflate&quot; already works</p>

</li>
</ul>

</li>
<li><p>PAR now supports pluggable <i>input filters</i> with <code>pp -f</code></p>

<ul>

<li><p>Bundled examples: Bleach, PodStrip and PatchContent</p>

</li>
<li><p>True encryption using <code>Crypt::*</code></p>

</li>
<li><p>Or even _product activation_ over the internet</p>

</li>
</ul>

</li>
<li><p>Alternatively, just keep core logic in your server and use RPC</p>

</li>
</ul>

<h2 id="Accessing-packed-files">Accessing packed files</h2>

<ul>

<li><p>To get the host archive from a packed program:</p>

<pre><code> <span class="keyword">my</span> <span class="variable">$zip</span> <span class="operator">=</span> <span class="variable">PAR::par_handle</span><span class="operator">(</span><span class="variable">$0</span><span class="operator">);</span> <span class="comment"># an Archive::Zip object</span>
 <span class="keyword">my</span> <span class="variable">$content</span> <span class="operator">=</span> <span class="variable">$zip</span><span class="operator">-&gt;</span><span class="variable">contents</span><span class="operator">(</span><span class="string">'MANIFEST'</span><span class="operator">);</span>
</code></pre>

</li>
<li><p>Same thing, but with <code>read_file()</code>:</p>

<pre><code> <span class="keyword">my</span> <span class="variable">$content</span> <span class="operator">=</span> <span class="variable">PAR::read_file</span><span class="operator">(</span><span class="string">'MANIFEST'</span><span class="operator">);</span>
</code></pre>

</li>
<li><p>Loaded PAR files are stored in <code>%PAR::LibCache</code>:</p>

<pre><code> <span class="keyword">use</span> <span class="variable">PAR</span> <span class="string">'/home/mylibs/*.par'</span><span class="operator">;</span>
 <span class="keyword">while</span> <span class="operator">(</span><span class="keyword">my</span> <span class="operator">(</span><span class="variable">$filename</span><span class="operator">,</span> <span class="variable">$zip</span><span class="operator">)</span> <span class="operator">=</span> <span class="keyword">each</span> <span class="variable">%PAR::LibCache</span><span class="operator">)</span> <span class="operator">{</span>
     <span class="keyword">print</span> <span class="string">"[</span><span class="variable">$filename</span><span class="string"> - MANIFEST]\n"</span><span class="operator">;</span>
     <span class="keyword">print</span> <span class="variable">$zip</span><span class="operator">-&gt;</span><span class="variable">contents</span><span class="operator">(</span><span class="string">'MANIFEST'</span><span class="operator">);</span>
 <span class="operator">}</span>
</code></pre>

</li>
</ul>

<h2 id="Packing-GUI-applications">Packing GUI applications</h2>

<ul>

<li><p>GUI toolkits often need to link with shared libraries:</p>

<pre><code> # search for libncurses under library paths and pack it
 % pp -l ncurses curses_app.pl  # same for Tk, Wx, Gtk, Qt...</code></pre>

</li>
<li><p>Use <code>pp --gui</code> on Win32 to eliminate the console window:</p>

<pre><code> # pack &#39;src.pl&#39; into a console-less &#39;out.exe&#39; (Win32 only)
 % pp --gui -o out.exe src.pl</code></pre>

</li>
<li><p>&quot;Can&#39;t locate Foo/Widget/Bar.pm in @INC&quot;?</p>

<ul>

<li><p>Some toolkits (notably Tk) autoloads modules without <code>use</code> or <code>require</code></p>

</li>
<li><p>Hence <code>pp</code> and <code>Module::ScanDeps</code> may fail to detect them</p>

</li>
<li><p>Tk problems mostly fixed by now, but other toolkits may still break</p>

</li>
<li><p>You can work around it with <code>pp -M</code> or an explicit <code>require</code></p>

</li>
<li><p>Or better, send a short test-case to <code>par@perl.org</code> so we can fix it</p>

</li>
</ul>

</li>
</ul>

<h2 id="Precompiled-CPAN-distributions">Precompiled CPAN distributions</h2>

<ul>

<li><p>Installing XS extensions from CPAN was difficult</p>

<ul>

<li><p>Some platforms do not come with a compiler (Win32, MacOSX...)</p>

</li>
<li><p>Some headers or libraries may be missing</p>

</li>
<li><p>PAR.pm itself used to suffer from both problems</p>

</li>
</ul>

</li>
<li><p>...but not anymore -- <code>Module::Install</code> to the rescue!</p>

<pre><code> <span class="comment"># same old Makefile.PL, with a few changes</span>
 <span class="keyword">use</span> <span class="variable">inc::Module::Install</span><span class="operator">;</span>      <span class="comment"># was "use ExtUtils::MakeMaker;"</span>
 <span class="variable">WriteMakefile</span><span class="operator">(</span> <span class="operator">...</span> <span class="operator">);</span>          <span class="comment"># same as the original</span>
 <span class="variable">check_nmake</span><span class="operator">();</span>                 <span class="comment"># make sure the user have nmake</span>
 <span class="variable">par_base</span><span class="operator">(</span><span class="string">'AUTRIJUS'</span><span class="operator">);</span>          <span class="comment"># your CPAN ID or a URL</span>
 <span class="variable">fetch_par</span><span class="operator">()</span> <span class="keyword">unless</span> <span class="variable">can_cc</span><span class="operator">();</span>   <span class="comment"># use precompiled PAR only if necessary</span>
</code></pre>

</li>
<li><p>Users will not notice anything, except now it works</p>

<ul>

<li><p>Of course, you still need to type <code>make par</code> and upload the precompiled package</p>

</li>
<li><p>PAR users can also install it directly with <code>parl -i</code></p>

</li>
</ul>

</li>
</ul>

<h2 id="Platform-specific-Tips">Platform-specific Tips</h2>

<ul>

<li><p>Win32 and other icon-savvy platforms</p>

<ul>

<li><p>Needs 3rd-party tools to add icons to <code>pp</code>-generated executables</p>

</li>
<li><p>PE Header manipulation in Perl -- volunteers wanted!</p>

</li>
</ul>

</li>
<li><p>Linux and other libc-based platforms</p>

<ul>

<li><p>Try to avoid running <code>pp</code> on a bleeding-edge version of the OS</p>

</li>
<li><p>Older versions with an earlier libc won&#39;t work with new ones</p>

</li>
</ul>

</li>
<li><p>Solaris and other zlib-lacking platforms (but not Win32)</p>

<ul>

<li><p>You need a static-linked <code>Compress::Zlib</code> before installing PAR</p>

</li>
<li><p>In the future, PAR may depend on <code>Compress::Zlib::Static</code> instead</p>

</li>
</ul>

</li>
<li><p>Any platform with limited bandwidth or disk space</p>

<ul>

<li><p>Use UPX to minimize the executable size</p>

</li>
</ul>

</li>
</ul>

<h2 id="Thank-you">Thank you!</h2>

<ul>

<li><p>Additional resources</p>

<ul>

<li><p>Mailing list: <code>par@perl.org</code></p>

</li>
<li><p>Subscribe: Send a blank email to <code>par-subscribe@perl.org</code></p>

</li>
<li><p>List archive: <a href="http://nntp.x.perl.org/group/perl.par">http://nntp.x.perl.org/group/perl.par</a></p>

</li>
<li><p>PAR::Intro: <a href="http://search.cpan.org/dist/PAR/lib/PAR/Intro.pod">http://search.cpan.org/dist/PAR/lib/PAR/Intro.pod</a></p>

</li>
<li><p>Apache::PAR: <a href="http://search.cpan.org/dist/Apache-PAR/">http://search.cpan.org/dist/Apache-PAR/</a></p>

</li>
<li><p>Module::Install: <a href="http://search.cpan.org/dist/Module-Install/">http://search.cpan.org/dist/Module-Install/</a></p>

</li>
</ul>

</li>
<li><p>Any questions?</p>

</li>
</ul>

<h2 id="Bonus-Slides:-PAR-Internals">Bonus Slides: PAR Internals</h2>

<h2 id="Overview-of-PAR.pms-Implementation">Overview of PAR.pm&#39;s Implementation</h2>

<ul>

<li><p>Here begins the scary part</p>

<ul>

<li><p>Grues, Dragons and Jabberwocks abound...</p>

</li>
<li><p>You are going to learn weird things about Perl internals</p>

</li>
</ul>

</li>
<li><p>PAR invokes four areas of Perl arcana:</p>

<ul>

<li><p>@INC code references</p>

</li>
<li><p>On-the-fly source filtering</p>

</li>
<li><p>Overriding <code>DynaLoader::bootstrap()</code> to handle XS modules</p>

</li>
<li><p>Making self-bootstrapping binary executables</p>

</li>
</ul>

</li>
<li><p>The first two only works on 5.6 or later</p>

<ul>

<li><p>DynaLoader and <code>%INC</code> are there since Perl 5 was born</p>

</li>
<li><p>PAR currently needs 5.6, but a 5.005 port is possible</p>

</li>
</ul>

</li>
</ul>

<h2 id="Code-References-in-INC">Code References in @INC</h2>

<ul>

<li><p>On 1999-07-19, Ken Fox submitted a patch to P5P</p>

<ul>

<li><p>To _enable using remote modules_ by putting hooks in @INC</p>

</li>
<li><p>It&#39;s accepted to come in Perl 5.6, but undocumented until 5.8</p>

</li>
<li><p>Type <code>perldoc -f require</code> to read the nitty-gritty details</p>

</li>
</ul>

</li>
<li><p>Coderefs in @INC may return a fh, or undef to &#39;pass&#39;:</p>

<pre><code> <span class="keyword">push</span> <span class="variable">@INC</span><span class="operator">,</span> <span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
     <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$coderef</span><span class="operator">,</span> <span class="variable">$filename</span><span class="operator">)</span> <span class="operator">=</span> <span class="variable">@_</span><span class="operator">;</span>  <span class="comment"># $coderef is \&amp;my_sub</span>
     <span class="keyword">open</span> <span class="keyword">my</span> <span class="variable">$fh</span><span class="operator">,</span> <span class="string">"wget ftp://example.com/</span><span class="variable">$filename</span><span class="string"> |"</span><span class="operator">;</span>
     <span class="keyword">return</span> <span class="variable">$fh</span><span class="operator">;</span>        <span class="comment"># using remote modules, indeed!</span>
 <span class="operator">};</span>
</code></pre>

</li>
<li><p>Perl 5.8 let you open a file handle to a string, so we just use that:</p>

<pre><code>        <span class="keyword">open</span> <span class="keyword">my</span> <span class="variable">$fh</span><span class="operator">,</span> <span class="string">'&lt;'</span><span class="operator">,</span> <span class="operator">\(</span><span class="variable">$zip</span><span class="operator">-&gt;</span><span class="variable">memberNamed</span><span class="operator">(</span><span class="variable">$filename</span><span class="operator">)-&gt;</span><span class="variable">contents</span><span class="operator">);</span>
        <span class="keyword">return</span> <span class="variable">$fh</span><span class="operator">;</span>
</code></pre>

</li>
<li><p>But Perl 5.6 does not have that, and I don&#39;t want to use temp files...</p>

</li>
</ul>

<h2 id="Source-Filtering-without-Filter::-Modules">Source Filtering without Filter::* Modules</h2>

<ul>

<li><p>... Undocumented features to the rescue!</p>

<ul>

<li><p>It turns out that @INC hooks can return <b>two</b> values</p>

</li>
<li><p>The first is still the file handle</p>

</li>
<li><p>The second is a code reference for line-by-line source filtering!</p>

</li>
</ul>

</li>
<li><p>This is how <code>Acme::use::strict::with::pride</code> works:</p>

<pre><code> <span class="comment"># Force all modules used to use strict and warnings</span>
 <span class="keyword">open</span> <span class="keyword">my</span> <span class="variable">$fh</span><span class="operator">,</span> <span class="string">"&lt;"</span><span class="operator">,</span> <span class="variable">$filename</span> <span class="keyword">or</span> <span class="keyword">return</span><span class="operator">;</span>
 <span class="keyword">my</span> <span class="variable">@lines</span> <span class="operator">=</span> <span class="operator">(</span><span class="string">"use strict; use warnings;\n"</span><span class="operator">,</span> <span class="string">"#line 1 \"</span><span class="variable">$full</span><span class="string">\"\n"</span><span class="operator">);</span>
 <span class="keyword">return</span> <span class="operator">(</span><span class="variable">$fh</span><span class="operator">,</span> <span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
     <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">unless</span> <span class="variable">@lines</span><span class="operator">;</span>    
     <span class="keyword">push</span> <span class="variable">@lines</span><span class="operator">,</span> <span class="variable">$_</span><span class="operator">;</span> <span class="variable">$_</span> <span class="operator">=</span> <span class="keyword">shift</span> <span class="variable">@lines</span><span class="operator">;</span> <span class="keyword">return</span> <span class="keyword">length</span> <span class="variable">$_</span><span class="operator">;</span>
 <span class="operator">});</span>
</code></pre>

</li>
</ul>

<h2 id="Source-Filtering-without-Filter::-Modules-cont">Source Filtering without Filter::* Modules (cont.)</h2>

<ul>

<li><p>But we don&#39;t really have a filehandle for anything</p>

</li>
<li><p>Another undocumented feature saves the day!</p>

</li>
<li><p>We can actually omit the first return value altogether:</p>

<pre><code> <span class="comment"># Return all contents line-by-line from the file inside PAR</span>
 <span class="keyword">my</span> <span class="variable">@lines</span> <span class="operator">=</span> <span class="keyword">split</span><span class="operator">(</span>
     <span class="regex">/(?&lt;=\n)/</span><span class="operator">,</span>
     <span class="variable">$zip</span><span class="operator">-&gt;</span><span class="variable">memberNamed</span><span class="operator">(</span><span class="variable">$filename</span><span class="operator">)-&gt;</span><span class="variable">contents</span>
 <span class="operator">);</span>
 <span class="keyword">return</span> <span class="operator">(</span><span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
     <span class="variable">$_</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">(</span><span class="variable">@lines</span><span class="operator">);</span>
     <span class="keyword">return</span> <span class="keyword">length</span> <span class="variable">$_</span><span class="operator">;</span>
 <span class="operator">});</span>
</code></pre>

</li>
</ul>

<h2 id="Overriding-DynaLoader::bootstrap">Overriding DynaLoader::bootstrap</h2>

<ul>

<li><p>XS modules have dynamically loaded libraries</p>

<ul>

<li><p>They cannot be loaded as part of a zip file, so we extract them out</p>

</li>
<li><p>Must intercept DynaLoader&#39;s library-finding process</p>

</li>
</ul>

</li>
<li><p>Module names are passed to <code>bootstrap</code> for XS loading</p>

<ul>

<li><p>During the process, it calls <code>dl_findfile</code> to locate the file</p>

</li>
<li><p>So we install pre-hooks around both functions</p>

</li>
</ul>

</li>
<li><p>Our <code>_bootstrap</code> just checks if the library is in PARs</p>

<ul>

<li><p>If yes, extract it to a <code>File::Temp</code> temp file</p>

<ul>

<li><p>The file will be automatically cleaned up when the program ends</p>

</li>
</ul>

</li>
<li><p>It then pass the arguments to the original <code>bootstrap</code></p>

</li>
<li><p>Finally, our <code>dl_findfile</code> intercepts known filenames and return it</p>

</li>
</ul>

</li>
</ul>

<h2 id="Anatomy-of-a-Self-Contained-PAR-executable">Anatomy of a Self-Contained PAR executable</h2>

<ul>

<li><p>The par script ($0) itself</p>

<ul>

<li><p>May be in plain-text or native executable format</p>

</li>
</ul>

</li>
<li><p>Any number of embedded files</p>

<ul>

<li><p>Typically used to bootstrap PAR&#39;s various dependencies</p>

</li>
<li><p>Each section begins with the magic string &quot;FILE&quot;</p>

</li>
<li><p>Length of filename in pack(&#39;N&#39;) format and the filename (auto/.../)</p>

</li>
<li><p>File length in pack(&#39;N&#39;) and the file&#39;s content (not compressed)</p>

</li>
</ul>

</li>
<li><p>One PAR file</p>

<ul>

<li><p>Just a regular zip file with the magic string <code>&quot;PK\003\004&quot;</code></p>

</li>
</ul>

</li>
<li><p>Ending section</p>

<ul>

<li><p>A pack(&#39;N&#39;) number of the total length of FILE and PAR sections</p>

</li>
<li><p>Finally, there must be a 8-bytes magic string: <code>&quot;\012PAR.pm\012&quot;</code></p>

</li>
</ul>

</li>
</ul>

<h2 id="Self-Bootstrapping-Tricks">Self-Bootstrapping Tricks</h2>

<ul>

<li><p>All we can expect is a working perl interpreter</p>

<ul>

<li><p>The self-contained script *must not* use any modules at all</p>

</li>
<li><p>But to process PAR files, we need XS modules like Compress::Zlib</p>

</li>
</ul>

</li>
<li><p>Answer: bundle all modules + libraries used by PAR.pm</p>

<ul>

<li><p>That&#39;s what the <code>FILE</code> section in the previous slide is for</p>

</li>
<li><p>Load modules to memory, and write object files to disk</p>

</li>
<li><p>Then use a local <code>@INC</code> hook to load them on demand</p>

</li>
</ul>

</li>
<li><p>Minimizing the amount of temporary files</p>

<ul>

<li><p>First, try to load PerlIO::scalar and File::Temp</p>

</li>
<li><p>Set up an END hook to unlink all temp files up to this point</p>

</li>
<li><p>Load other bundled files, and look in the compressed PAR section</p>

</li>
<li><p>This can be much easier with a pure-perl <code>inflate()</code>; patches welcome!</p>

</li>
</ul>

</li>
</ul>

<h2 id="Thank-you-again">Thank you (again)!</h2>

<ul>

<li><p>Any questions, <i>please</i>?</p>

</li>
</ul>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<p><a href="../../../cpan/build/PAR-1.008-zOnYU5/blib/lib/PAR.html">PAR</a>, <a>pp</a>, <a>par.pl</a>, <a>parl</a></p>

<p><a>ex::lib::zip</a>, <a>Acme::use::strict::with::pride</a></p>

<p><a>App::Packer</a>, <a>Apache::PAR</a>, <a>CPANPLUS</a>, <a>Module::Install</a></p>

<h1 id="AUTHORS">AUTHORS</h1>

<p>Audrey Tang &lt;cpan@audreyt.org&gt;</p>

<p><a href="http://par.perl.org/">http://par.perl.org/</a> is the official PAR website. You can write to the mailing list at &lt;par@perl.org&gt;, or send an empty mail to &lt;par-subscribe@perl.org&gt; to participate in the discussion.</p>

<p>Please submit bug reports to &lt;bug-par@rt.cpan.org&gt;.</p>

<h1 id="COPYRIGHT">COPYRIGHT</h1>

<p>Copyright 2003, 2004, 2005, 2006 by Audrey Tang &lt;cpan@audreyt.org&gt;.</p>

<p>This document is free documentation; you can redistribute it and/or modify it under the same terms as Perl itself.</p>

<p>See <a href="http://www.perl.com/perl/misc/Artistic.html">http://www.perl.com/perl/misc/Artistic.html</a></p>


</body>

</html>


